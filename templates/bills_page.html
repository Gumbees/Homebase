{% extends 'base.html' %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-5 mb-4">
            <i class="fas fa-file-invoice me-2"></i> Bills (Unpaid Invoices)
            <a href="{{ url_for('paid_receipts') }}" class="btn btn-outline-secondary">
                <i class="fas fa-receipt me-2"></i> View Paid Receipts
            </a>
        </h1>
        
        {% if bills %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Bill #</th>
                            <th>Date</th>
                            <th>Vendor</th>
                            <th>Amount</th>
                            <th>Due Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for bill in bills %}
                            <tr>
                                <td>{{ bill.invoice_number }}</td>
                                <td>{{ bill.data.date if bill.data.date else 'N/A' }}</td>
                                <td>
                                    {% if bill.vendor_id %}
                                        <a href="{{ url_for('view_vendor', vendor_id=bill.vendor_id) }}">
                                            {{ bill.vendor.name }}
                                        </a>
                                    {% else %}
                                        {{ bill.data.vendor_name if bill.data.vendor_name else 'Unknown' }}
                                        <button class="btn btn-sm btn-outline-primary link-vendor-btn" data-bs-toggle="modal" data-bs-target="#linkVendorModal" data-bill-id="{{ bill.id }}">
                                            <i class="fas fa-link"></i>
                                        </button>
                                    {% endif %}
                                </td>
                                <td>${{ "%.2f"|format(bill.data.total_amount|float) if bill.data.total_amount else '0.00' }}</td>
                                <td>
                                    {% if bill.data.due_date %}
                                        {{ bill.data.due_date }}
                                        {% set is_overdue = bill.data.due_date < today %}
                                        {% if is_overdue %}
                                            <span class="badge bg-danger">Overdue</span>
                                        {% endif %}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-warning">Pending</span>
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <a href="{{ url_for('view_bill', bill_id=bill.id) }}" class="btn btn-sm btn-outline-info">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="{{ url_for('mark_bill_paid', bill_id=bill.id) }}" class="btn btn-sm btn-outline-success" title="Mark as Paid">
                                            <i class="fas fa-check"></i>
                                        </a>
                                        <button class="btn btn-sm btn-outline-warning re-evaluate-btn" 
                                                data-bill-id="{{ bill.id }}"
                                                title="Re-evaluate with AI">
                                            <i class="fas fa-sync-alt"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i> No unpaid bills found.
            </div>
        {% endif %}
    </div>
</div>

<!-- Link Vendor Modal -->
<div class="modal fade" id="linkVendorModal" tabindex="-1" aria-labelledby="linkVendorModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="linkVendorModalLabel">Link Bill to Vendor</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="bill_id" value="">
                <div class="form-group mb-3">
                    <label for="vendor_select" class="form-label">Select Vendor</label>
                    <select class="form-select" id="vendor_select">
                        <option value="">-- Select a Vendor --</option>
                        {% for vendor in vendors %}
                            <option value="{{ vendor.id }}">{{ vendor.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="text-end">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="linkVendorBtn">Link Vendor</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Link vendor to bill functionality
        const linkVendorModal = document.getElementById('linkVendorModal');
        if (linkVendorModal) {
            linkVendorModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                const billId = button.getAttribute('data-bill-id');
                document.getElementById('bill_id').value = billId;
            });
            
            const linkVendorBtn = document.getElementById('linkVendorBtn');
            linkVendorBtn.addEventListener('click', function() {
                const billId = document.getElementById('bill_id').value;
                const vendorId = document.getElementById('vendor_select').value;
                
                if (!vendorId) {
                    alert('Please select a vendor.');
                    return;
                }
                
                // Call API to link invoice to vendor
                fetch('/api/link-invoice-vendor', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        invoice_id: billId,
                        vendor_id: vendorId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Close the modal and reload the page
                        bootstrap.Modal.getInstance(linkVendorModal).hide();
                        window.location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while linking the vendor.');
                });
            });
        }
        
        // Re-evaluate bill functionality
        document.querySelectorAll('.re-evaluate-btn').forEach(button => {
            button.addEventListener('click', function() {
                const billId = this.getAttribute('data-bill-id');
                const btn = this;
                
                // Change button appearance while processing
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                btn.disabled = true;
                
                // Call the re-evaluate API
                fetch(`/api/re-evaluate-receipt/${billId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            btn.innerHTML = '<i class="fas fa-check"></i>';
                            setTimeout(() => {
                                btn.innerHTML = '<i class="fas fa-sync-alt"></i>';
                                btn.disabled = false;
                                window.location.reload(); // Reload to show updated data
                            }, 1000);
                        } else {
                            btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
                            setTimeout(() => {
                                btn.innerHTML = '<i class="fas fa-sync-alt"></i>';
                                btn.disabled = false;
                            }, 1000);
                            alert('Error: ' + data.error);
                        }
                    })
                    .catch(error => {
                        btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
                        setTimeout(() => {
                            btn.innerHTML = '<i class="fas fa-sync-alt"></i>';
                            btn.disabled = false;
                        }, 1000);
                        console.error('Error:', error);
                    });
            });
        });
    });
</script>
{% endblock %}