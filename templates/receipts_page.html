{% extends 'base.html' %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-5 mb-4">
            <i class="fas fa-receipt me-2"></i> Receipts
            <button class="btn btn-primary float-end" data-bs-toggle="modal" data-bs-target="#uploadReceiptModal">
                <i class="fas fa-plus me-2"></i> Add Receipt
            </button>
        </h1>
        
        {% if receipts %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Receipt #</th>
                            <th>Date</th>
                            <th>Vendor</th>
                            <th>Amount</th>
                            <th>Items</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for receipt in receipts %}
                            <tr>
                                <td>{{ receipt.invoice_number }}</td>
                                <td>{{ receipt.data.date if receipt.data.date else 'N/A' }}</td>
                                <td>
                                    {% if receipt.vendor_id %}
                                        <a href="{{ url_for('view_vendor', vendor_id=receipt.vendor_id) }}">
                                            {{ receipt.vendor.name }}
                                        </a>
                                    {% else %}
                                        {{ receipt.data.vendor_name if receipt.data.vendor_name else 'Unknown' }}
                                    {% endif %}
                                </td>
                                <td>${{ "%.2f"|format(receipt.data.total_amount|float) if receipt.data.total_amount else '0.00' }}</td>
                                <td>
                                    <span class="badge bg-info">{{ receipt.line_items|length }}</span>
                                </td>
                                <td>
                                    <a href="{{ url_for('view_receipt', receipt_id=receipt.id) }}" class="btn btn-sm btn-outline-info">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <button class="btn btn-sm btn-outline-warning re-evaluate-btn" 
                                            data-receipt-id="{{ receipt.id }}"
                                            title="Re-evaluate with AI">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i> No receipts found. Upload a receipt to get started.
            </div>
        {% endif %}
    </div>
</div>

<!-- Upload Receipt Modal -->
<div class="modal fade" id="uploadReceiptModal" tabindex="-1" aria-labelledby="uploadReceiptModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadReceiptModalLabel">Upload Receipt</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('receipt_upload') }}" method="post" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="receipt_image" class="form-label">Receipt Image</label>
                        <input type="file" class="form-control" id="receipt_image" name="receipt_image" accept="image/jpeg,image/png,image/gif,application/pdf" required>
                        <div class="form-text">Upload a clear image of your receipt (JPG, PNG, GIF or PDF)</div>
                    </div>
                    
                    <!-- Camera Capture Option for Mobile -->
                    <div class="mb-3 d-md-none">
                        <label class="form-label">Or capture with camera</label>
                        <button type="button" class="btn btn-secondary w-100" id="capturePhotoBtn">
                            <i class="fas fa-camera me-2"></i> Capture Photo
                        </button>
                    </div>

                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="auto_analyze" name="auto_analyze" value="true" checked>
                            <label class="form-check-label" for="auto_analyze">Automatically analyze line items and create objects</label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="auto_link" name="auto_link" value="true" checked>
                            <label class="form-check-label" for="auto_link">Auto-link to existing objects when possible</label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">AI Model for Processing</label>
                        <div class="d-flex gap-2">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="ai_model" id="model_claude" value="claude" checked>
                                <label class="form-check-label" for="model_claude">
                                    <i class="fas fa-robot me-1"></i> Claude (Anthropic)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="ai_model" id="model_openai" value="openai">
                                <label class="form-check-label" for="model_openai">
                                    <i class="fas fa-brain me-1"></i> GPT-4o (OpenAI)
                                </label>
                            </div>
                        </div>
                        <div class="form-text">Select which AI model to use for processing. Default is Claude.</div>
                    </div>
                    
                    <!-- Preview Area for Mobile Camera -->
                    <div id="cameraPreviewArea" class="d-none">
                        <div class="mb-3">
                            <label class="form-label">Preview & Crop</label>
                            <div class="border rounded p-2 text-center bg-dark">
                                <canvas id="previewCanvas" class="img-fluid"></canvas>
                            </div>
                        </div>
                        <div class="mb-3 d-flex justify-content-between">
                            <button type="button" class="btn btn-secondary" id="retakePhotoBtn">
                                <i class="fas fa-redo me-1"></i> Retake
                            </button>
                            <button type="button" class="btn btn-primary" id="acceptPhotoBtn">
                                <i class="fas fa-check me-1"></i> Accept
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-upload me-1"></i> Upload Receipt
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Setup for Re-evaluate buttons
    document.querySelectorAll('.re-evaluate-btn').forEach(button => {
        button.addEventListener('click', function() {
            const receiptId = this.getAttribute('data-receipt-id');
            const button = this; // Reference to the button
            
            // Change button appearance while processing
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            button.disabled = true;
            
            // Call the re-evaluate API
            fetch(`/api/re-evaluate-receipt/${receiptId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        button.innerHTML = '<i class="fas fa-check"></i>';
                        setTimeout(() => {
                            button.innerHTML = '<i class="fas fa-sync-alt"></i>';
                            button.disabled = false;
                            window.location.reload(); // Reload to show updated data
                        }, 1000);
                    } else {
                        button.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
                        setTimeout(() => {
                            button.innerHTML = '<i class="fas fa-sync-alt"></i>';
                            button.disabled = false;
                        }, 1000);
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    button.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
                    setTimeout(() => {
                        button.innerHTML = '<i class="fas fa-sync-alt"></i>';
                        button.disabled = false;
                    }, 1000);
                    console.error('Error:', error);
                });
        });
    });
    
    // Mobile camera functionality
    const capturePhotoBtn = document.getElementById('capturePhotoBtn');
    const retakePhotoBtn = document.getElementById('retakePhotoBtn');
    const acceptPhotoBtn = document.getElementById('acceptPhotoBtn');
    const cameraPreviewArea = document.getElementById('cameraPreviewArea');
    const previewCanvas = document.getElementById('previewCanvas');
    const fileInput = document.getElementById('receipt_image');
    
    if (capturePhotoBtn) {
        capturePhotoBtn.addEventListener('click', function() {
            // Create a file input element to capture a photo
            const tempInput = document.createElement('input');
            tempInput.type = 'file';
            tempInput.accept = 'image/*';
            tempInput.capture = 'environment'; // Use the back camera
            
            tempInput.addEventListener('change', function(event) {
                if (event.target.files && event.target.files[0]) {
                    const file = event.target.files[0];
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        // Show the preview area
                        cameraPreviewArea.classList.remove('d-none');
                        
                        // Create an image element to load the captured photo
                        const img = new Image();
                        img.onload = function() {
                            // Set canvas dimensions to match the image (capped at a reasonable size)
                            const maxWidth = 800;
                            const maxHeight = 800;
                            let width = img.width;
                            let height = img.height;
                            
                            // Scale down if the image is too large
                            if (width > maxWidth) {
                                height = (height * maxWidth) / width;
                                width = maxWidth;
                            }
                            if (height > maxHeight) {
                                width = (width * maxHeight) / height;
                                height = maxHeight;
                            }
                            
                            previewCanvas.width = width;
                            previewCanvas.height = height;
                            
                            // Draw the image on the canvas
                            const ctx = previewCanvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                        };
                        img.src = e.target.result;
                    };
                    
                    reader.readAsDataURL(file);
                }
            });
            
            // Trigger the file selection dialog
            tempInput.click();
        });
    }
    
    if (retakePhotoBtn) {
        retakePhotoBtn.addEventListener('click', function() {
            cameraPreviewArea.classList.add('d-none');
        });
    }
    
    if (acceptPhotoBtn) {
        acceptPhotoBtn.addEventListener('click', function() {
            // Convert canvas to blob and set it to the file input
            previewCanvas.toBlob(function(blob) {
                const file = new File([blob], "receipt-photo.jpg", { type: "image/jpeg" });
                
                // Create a DataTransfer object and add the file
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                fileInput.files = dataTransfer.files;
                
                // Hide the preview area
                cameraPreviewArea.classList.add('d-none');
            }, 'image/jpeg', 0.9);
        });
    }
});
</script>
{% endblock %}