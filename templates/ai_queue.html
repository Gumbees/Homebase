{% extends 'base.html' %}

{% block title %}AI Re-evaluation Queue{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">AI Re-evaluation Queue</h1>
    
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Daily Quota Status</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h2>{{ pending_today }}</h2>
                                    <p>Pending Today</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h2>{{ completed_today }}</h2>
                                    <p>Completed Today</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h2>{{ remaining_slots }}</h2>
                                    <p>Remaining Slots (Max: {{ daily_limit }})</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="row">
                        <div class="col-md-4">
                            <button id="btn-schedule" class="btn btn-primary btn-block">
                                <i class="fas fa-calendar-plus"></i> Schedule Evaluations
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button id="btn-process" class="btn btn-success btn-block">
                                <i class="fas fa-cogs"></i> Process Queue
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button id="btn-run-daily" class="btn btn-info btn-block">
                                <i class="fas fa-play-circle"></i> Run Daily Routine
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Objects Due for Re-evaluation -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-warning text-white">
                    <h5 class="mb-0">Objects Due for Re-evaluation ({{ due_objects|length }})</h5>
                </div>
                <div class="card-body p-0">
                    {% if due_objects %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0">
                            <thead class="thead-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Due Date</th>
                                    <th>Last Evaluated</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for obj in due_objects %}
                                <tr>
                                    <td>{{ obj.id }}</td>
                                    <td>{{ obj.name() }}</td>
                                    <td>
                                        <span class="badge 
                                            {% if obj.object_type == 'asset' %}bg-success
                                            {% elif obj.object_type == 'consumable' %}bg-info
                                            {% elif obj.object_type == 'component' %}bg-primary
                                            {% elif obj.object_type == 'person' %}bg-warning
                                            {% elif obj.object_type == 'pet' %}bg-danger
                                            {% elif obj.object_type == 'service' %}bg-secondary
                                            {% elif obj.object_type == 'software' %}bg-dark
                                            {% else %}bg-light{% endif %}">
                                            {{ obj.object_type }}
                                        </span>
                                    </td>
                                    <td>{{ obj.next_evaluation_date.strftime('%Y-%m-%d') }}</td>
                                    <td>
                                        {% if obj.last_evaluated_at %}
                                            {{ obj.last_evaluated_at.strftime('%Y-%m-%d') }}
                                        {% else %}
                                            Never
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-primary schedule-btn" data-id="{{ obj.id }}">
                                            Schedule
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="p-4 text-center">
                        <p class="mb-0">No objects due for re-evaluation at this time.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Pending Queue -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Pending Queue ({{ pending_queue|length }})</h5>
                </div>
                <div class="card-body p-0">
                    {% if pending_queue %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0">
                            <thead class="thead-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>Object</th>
                                    <th>Type</th>
                                    <th>Scheduled Date</th>
                                    <th>Created</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in pending_queue %}
                                <tr>
                                    <td>{{ item.id }}</td>
                                    <td>
                                        {% if item.object %}
                                            {{ item.object.name() }}
                                        {% else %}
                                            Object #{{ item.object_id }} (deleted)
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.object %}
                                        <span class="badge 
                                            {% if item.object.object_type == 'asset' %}bg-success
                                            {% elif item.object.object_type == 'consumable' %}bg-info
                                            {% elif item.object.object_type == 'component' %}bg-primary
                                            {% elif item.object.object_type == 'person' %}bg-warning
                                            {% elif item.object.object_type == 'pet' %}bg-danger
                                            {% elif item.object.object_type == 'service' %}bg-secondary
                                            {% elif item.object.object_type == 'software' %}bg-dark
                                            {% else %}bg-light{% endif %}">
                                            {{ item.object.object_type }}
                                        </span>
                                        {% else %}
                                        <span class="badge bg-secondary">unknown</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ item.scheduled_date.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                    <td>{{ item.created_at.strftime('%Y-%m-%d') }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="p-4 text-center">
                        <p class="mb-0">No pending evaluations in the queue.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Processing Queue -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Currently Processing ({{ processing_queue|length }})</h5>
                </div>
                <div class="card-body p-0">
                    {% if processing_queue %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0">
                            <thead class="thead-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>Object</th>
                                    <th>Scheduled Date</th>
                                    <th>Last Attempt</th>
                                    <th>Attempts</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in processing_queue %}
                                <tr>
                                    <td>{{ item.id }}</td>
                                    <td>
                                        {% if item.object %}
                                            {{ item.object.name() }}
                                        {% else %}
                                            Object #{{ item.object_id }} (deleted)
                                        {% endif %}
                                    </td>
                                    <td>{{ item.scheduled_date.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                    <td>{{ item.last_attempt.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                    <td>{{ item.attempts }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="p-4 text-center">
                        <p class="mb-0">No evaluations currently processing.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Manual Review Queue -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">Need Manual Review ({{ manual_review_objects|length }})</h5>
                </div>
                <div class="card-body p-0">
                    {% if manual_review_objects %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0">
                            <thead class="thead-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Last Evaluated</th>
                                    <th>Confidence</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for obj in manual_review_objects %}
                                <tr>
                                    <td>{{ obj.id }}</td>
                                    <td>{{ obj.name() }}</td>
                                    <td>
                                        <span class="badge 
                                            {% if obj.object_type == 'asset' %}bg-success
                                            {% elif obj.object_type == 'consumable' %}bg-info
                                            {% elif obj.object_type == 'component' %}bg-primary
                                            {% elif obj.object_type == 'person' %}bg-warning
                                            {% elif obj.object_type == 'pet' %}bg-danger
                                            {% elif obj.object_type == 'service' %}bg-secondary
                                            {% elif obj.object_type == 'software' %}bg-dark
                                            {% else %}bg-light{% endif %}">
                                            {{ obj.object_type }}
                                        </span>
                                    </td>
                                    <td>{{ obj.last_evaluated_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                    <td>{{ "%.2f"|format(obj.evaluation_confidence * 100) }}%</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary review-btn" data-id="{{ obj.id }}" 
                                                data-bs-toggle="modal" data-bs-target="#reviewModal">
                                            Review
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="p-4 text-center">
                        <p class="mb-0">No objects need manual review at this time.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recently Completed -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Recently Completed ({{ completed_queue|length }})</h5>
                </div>
                <div class="card-body p-0">
                    {% if completed_queue %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0">
                            <thead class="thead-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>Object</th>
                                    <th>Completed At</th>
                                    <th>Confidence</th>
                                    <th>Changes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in completed_queue %}
                                <tr>
                                    <td>{{ item.id }}</td>
                                    <td>
                                        {% if item.object %}
                                            {{ item.object.name() }}
                                        {% else %}
                                            Object #{{ item.object_id }} (deleted)
                                        {% endif %}
                                    </td>
                                    <td>{{ item.completed_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                    <td>
                                        {% if item.result and item.result.confidence %}
                                            {{ "%.2f"|format(item.result.confidence * 100) }}%
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-info view-result-btn" data-result="{{ item.result|tojson }}"
                                                data-bs-toggle="modal" data-bs-target="#resultModal">
                                            View Result
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="p-4 text-center">
                        <p class="mb-0">No completed evaluations to display.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Failed Queue -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">Failed Evaluations ({{ failed_queue|length }})</h5>
                </div>
                <div class="card-body p-0">
                    {% if failed_queue %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0">
                            <thead class="thead-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>Object</th>
                                    <th>Last Attempt</th>
                                    <th>Attempts</th>
                                    <th>Error</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in failed_queue %}
                                <tr>
                                    <td>{{ item.id }}</td>
                                    <td>
                                        {% if item.object %}
                                            {{ item.object.name() }}
                                        {% else %}
                                            Object #{{ item.object_id }} (deleted)
                                        {% endif %}
                                    </td>
                                    <td>{{ item.last_attempt.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                    <td>{{ item.attempts }}</td>
                                    <td>
                                        <span class="text-truncate d-inline-block" style="max-width: 300px;">
                                            {{ item.error_message }}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-warning retry-btn" data-id="{{ item.id }}">
                                            Retry
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="p-4 text-center">
                        <p class="mb-0">No failed evaluations to display.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Result Modal -->
<div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resultModalLabel">Evaluation Result</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <pre id="resultContent" class="bg-light p-3" style="max-height: 400px; overflow-y: auto;"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Review Modal -->
<div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reviewModalLabel">Review Object Evaluation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="reviewContent">
                    <div class="mb-3">
                        <h6>Evaluation Results</h6>
                        <div id="evaluationDetails" class="bg-light p-3 mb-3">
                            <!-- Evaluation details will be loaded here -->
                            <p class="text-center">Loading evaluation details...</p>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <h6>Suggested Updates</h6>
                        <div id="suggestedUpdates" class="bg-light p-3">
                            <!-- Suggested updates will be loaded here -->
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <h6>Next Evaluation</h6>
                        <div class="input-group">
                            <span class="input-group-text">Schedule next evaluation in</span>
                            <input type="number" class="form-control" id="nextEvaluationDays" value="90" min="1" max="365">
                            <span class="input-group-text">days</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="btnRejectUpdates">Reject Updates</button>
                <button type="button" class="btn btn-success" id="btnApproveUpdates">Approve Updates</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Process Queue button
        document.getElementById('btn-process').addEventListener('click', function() {
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-cog fa-spin"></i> Processing...';
            
            fetch('/api/ai-queue/process', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('success', data.message);
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                } else {
                    showAlert('danger', 'Error: ' + data.error);
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-cogs"></i> Process Queue';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('danger', 'Error processing queue: ' + error);
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-cogs"></i> Process Queue';
            });
        });
        
        // Schedule Evaluations button
        document.getElementById('btn-schedule').addEventListener('click', function() {
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-cog fa-spin"></i> Scheduling...';
            
            fetch('/api/ai-queue/schedule', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('success', data.message);
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                } else {
                    showAlert('danger', 'Error: ' + data.error);
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-calendar-plus"></i> Schedule Evaluations';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('danger', 'Error scheduling evaluations: ' + error);
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-calendar-plus"></i> Schedule Evaluations';
            });
        });
        
        // Run Daily button
        document.getElementById('btn-run-daily').addEventListener('click', function() {
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-cog fa-spin"></i> Running...';
            
            fetch('/api/ai-queue/run-daily', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('success', data.message);
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                } else {
                    showAlert('danger', 'Error: ' + data.error);
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-play-circle"></i> Run Daily Routine';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('danger', 'Error running daily routine: ' + error);
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-play-circle"></i> Run Daily Routine';
            });
        });
        
        // Schedule individual object buttons
        document.querySelectorAll('.schedule-btn').forEach(button => {
            button.addEventListener('click', function() {
                const objectId = this.getAttribute('data-id');
                this.disabled = true;
                this.innerHTML = '<i class="fas fa-cog fa-spin"></i>';
                
                fetch(`/api/objects/${objectId}/schedule-evaluation`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert('success', data.message);
                        setTimeout(() => {
                            location.reload();
                        }, 2000);
                    } else {
                        showAlert('danger', 'Error: ' + data.error);
                        this.disabled = false;
                        this.innerHTML = 'Schedule';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('danger', 'Error scheduling evaluation: ' + error);
                    this.disabled = false;
                    this.innerHTML = 'Schedule';
                });
            });
        });
        
        // View result buttons
        document.querySelectorAll('.view-result-btn').forEach(button => {
            button.addEventListener('click', function() {
                const resultData = JSON.parse(this.getAttribute('data-result'));
                document.getElementById('resultContent').textContent = 
                    JSON.stringify(resultData, null, 2);
            });
        });
        
        // Utility function to show alerts
        function showAlert(type, message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.setAttribute('role', 'alert');
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.firstChild);
            
            // Auto dismiss after 5 seconds
            setTimeout(() => {
                alertDiv.classList.remove('show');
                setTimeout(() => {
                    alertDiv.remove();
                }, 150);
            }, 5000);
        }
    });
</script>
{% endblock %}